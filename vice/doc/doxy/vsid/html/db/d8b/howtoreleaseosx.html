<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>vsid: how to make a macOS Distribution</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../vice-logo.svg"/></td>
  <td id="projectalign">
   <div id="projectname">vsid<span id="projectnumber">&#160;3.8</span>
   </div>
   <div id="projectbrief">Versatile Commodore Emulator and Virtual Commodore Environment</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('db/d8b/howtoreleaseosx.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">how to make a macOS Distribution </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><tt>
--------------------------------------------------------------------------------<br>
Binary Distribution:<br>
--------------------------------------------------------------------------------<br>
<br>
The binary distribution script now requires that MacPorts be used for<br>
dependencies. MacPorts can be configured to compile for older versions of macOS.<br>
<br>
1. Make sure Xcode 10 or earlier is active, otherwise the .app files created by<br>
&nbsp;&nbsp; platypus will require macOS 10.11. You can use xcode-select to choose which<br>
&nbsp;&nbsp; Xcode.app is the active one.<br>
<br>
2. Follow macOS-Howto.txt to get a MacPorts VICE build environment working.<br>
<br>
3. Bundled dependencies need to be rebuilt to target macOS 10.10 for x86_64 or<br>
&nbsp;&nbsp; 11.0 for arm64. First, set macosx_deployment_target to 10.10 or 11.0 in<br>
&nbsp;&nbsp; /opt/local/etc/macports/macports.conf.<br>
<br>
&nbsp;&nbsp; Then I usually then nuke all installed ports and start again with runtime deps<br>
&nbsp;&nbsp; built from source, like this:<br>
<br>
&nbsp;&nbsp; $ sudo port -N uninstall installed || true<br>
&nbsp;&nbsp; $ sudo port -N selfupdate<br>
&nbsp;&nbsp; $ sudo port -N -s install coreutils libomp<br>
&nbsp;&nbsp; $ sudo port -N -s install gtk3 +quartz<br>
&nbsp;&nbsp; $ sudo port -N -s install librsvg adwaita-icon-theme libsdl2 libsdl2_image lame glew libvorbis flac libjpeg-turbo<br>
&nbsp;&nbsp; $ sudo port -N -s install ffmpeg +darwinssl<br>
&nbsp;&nbsp; $ sudo port -N install platypus xa texlive-basic dos2unix<br>
<br>
4. Now build VICE against the reinstalled dependencies, and make the bindist:<br>
<br>
&nbsp;&nbsp; $ cd &lt;build folder&gt;<br>
<br>
&nbsp;&nbsp; SDL2:<br>
&nbsp;&nbsp; $ &lt;path to VICE source&gt;/configure \<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --enable-sdl2ui \<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --enable-lame \<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --enable-arch=no<br>
<br>
&nbsp;&nbsp; Gtk3:<br>
&nbsp;&nbsp; $ &lt;path to VICE source&gt;/configure \<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --enable-gtk3ui \<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --enable-lame \<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --enable-arch=no<br>
<br>
&nbsp;&nbsp; $ make clean<br>
&nbsp;&nbsp; $ make -j<br>
&nbsp;&nbsp; $ make bindistzip<br>
<br>
&nbsp;&nbsp; At some point soon it would be good to build with --enable-ffmpeg,<br>
&nbsp;&nbsp; but without including the dylibs in the bindary distribution and rely on<br>
&nbsp;&nbsp; locally installed version of ffmpeg. This works, however the app currently<br>
&nbsp;&nbsp; segfaults if it doesn't find the libs somewhere.<br>
<br>
--------------------------------------------------------------------------------<br>
Codesigning and notarising:<br>
--------------------------------------------------------------------------------<br>
<br>
Without codesigning, all versions of macOS will complain when you install<br>
and launch. Without notarising, it's a huge pain the arse to try and run<br>
the builds on macOS 10.15 Catalina. You'll need an Apple developer ID for<br>
codesigning, and a paid up Apple developer subscription to make a notarised<br>
build. Sorry :(<br>
<br>
1. Find your code signing ids:<br>
<br>
&nbsp;&nbsp; $ security find-identity -v -p codesigning<br>
<br>
&nbsp;&nbsp; You are looking for something like:<br>
&nbsp;&nbsp; "Developer ID Application: David Hogan (3RAEHPQQ6Z)"<br>
<br>
2. 'make bindist(zip)' will now code sign everything if the CODE_SIGN_ID<br>
&nbsp;&nbsp; environment variable is set:<br>
<br>
&nbsp;&nbsp; $ export CODE_SIGN_ID="&lt;Your code signing id&gt;"<br>
&nbsp;&nbsp; $ make bindistzip<br>
<br>
3. Follow Apple steps for notarisation at the URL below. If your Apple ID<br>
&nbsp;&nbsp; belongs to more than one team, you'll need to use the --asc-provider<br>
&nbsp;&nbsp; argument when you xcrun altool. You can xcode-select back to Xcode 11<br>
&nbsp;&nbsp; so that you can xcrun altool --list-providers to find the right id to<br>
&nbsp;&nbsp; use.<br>
<br>
&nbsp;&nbsp; https://tinyurl.com/macOS-notarisation<br>
<br>
&nbsp;&nbsp; See below for the notarisation script that I wrote the to automate the<br>
&nbsp;&nbsp; notarisation process for the offical VICE dmg files.<br>
<br>
--------------------------------------------------------------------------------<br>
Notarisation script<br>
--------------------------------------------------------------------------------<br>
<br>
#!/bin/bash<br>
set -o errexit<br>
set -o nounset<br>
<br>
APPLE_ID_EMAIL="&lt;your apple ID email address&gt;"<br>
NOTARISATION_PASSWORD="&lt;a single app password for your apple ID&gt;"<br>
NOTARISATION_PROVIDER="&lt;your asc provider, see below&gt;"<br>
<br>
#<br>
# You don't need the --asc-provider part if your apple ID is only in one team.<br>
#<br>
<br>
# verify that the signing looks ok<br>
codesign -vvv --deep --strict "$1"<br>
<br>
OUTPUT="$(mktemp)"<br>
xcrun altool --notarize-app \<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --primary-bundle-id "$1" \<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --username "$APPLE_ID_EMAIL" \<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --password "$NOTARISATION_PASSWORD" \<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --asc-provider "$NOTARISATION_PROVIDER" \<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --file "$1" \<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2&gt;&amp;1 | tee "$OUTPUT"<br>
UUID=$(awk '/RequestUUID/ { print $3 }' "$OUTPUT")<br>
<br>
if [ -z "$UUID" ]<br>
then<br>
&nbsp;&nbsp;&nbsp;&nbsp;echo "ERROR: Failed to capture RequestUUID from xcrun output".<br>
&nbsp;&nbsp;&nbsp;&nbsp;exit 1<br>
fi<br>
<br>
echo "Waiting for Status: success"<br>
<br>
while [ -z "$(grep "Status: success" "$OUTPUT")" ]<br>
do<br>
&nbsp;&nbsp;&nbsp;&nbsp;sleep 10<br>
&nbsp;&nbsp;&nbsp;&nbsp;xcrun altool --notarization-info "$UUID" \<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -u "$APPLE_ID_EMAIL" \<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -p "$NOTARISATION_PASSWORD" \<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2&gt;&amp;1 | tee "$OUTPUT"<br>
done<br>
<br>
xcrun stapler staple "$1"<br>
<br>
</tt>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Developer Information</a></li>
    <li class="footer">Generated on Sun Jun 16 2024 16:42:49 for vsid by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4 </li>
  </ul>
</div>
</body>
</html>
